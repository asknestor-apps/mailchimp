// Generated by CoffeeScript 1.10.0
(function() {
  var MailChimpAPI, apiKey, latestCampaign, listId, subscribeToList, unsubscribeFromList;

  MailChimpAPI = require('mailchimp').MailChimpAPI;

  apiKey = process.env.MAILCHIMP_API_KEY;

  listId = process.env.MAILCHIMP_LIST_ID;

  module.exports = function(robot) {
    robot.respond(/\bsubscribe (.+@.+)/i, function(message) {
      return subscribeToList(message);
    });
    robot.respond(/\bunsubscribe (.+@.+)/i, function(message) {
      return unsubscribeFromList(message);
    });
    return robot.respond(/\bmailchimp/i, function(message) {
      return latestCampaign(message);
    });
  };

  subscribeToList = function(message) {
    var api, emailAddress, error, error1;
    emailAddress = message.match[1];
    message.reply("Attempting to subscribe " + emailAddress + "...");
    try {
      api = new MailChimpAPI(apiKey, {
        version: "1.3",
        secure: false
      });
    } catch (error1) {
      error = error1;
      console.log(error.message);
      return;
    }
    return api.listSubscribe({
      id: listId,
      email_address: emailAddress,
      double_optin: false
    }, function(error, data) {
      if (error) {
        return message.send("Uh oh, something went wrong: " + error.message);
      } else {
        return message.send("You successfully subscribed " + emailAddress + ".");
      }
    });
  };

  unsubscribeFromList = function(message) {
    var api, emailAddress, error, error1;
    emailAddress = message.match[1];
    message.reply("Attempting to unsubscribe " + emailAddress + "...");
    try {
      api = new MailChimpAPI(apiKey, {
        version: "1.3",
        secure: false
      });
    } catch (error1) {
      error = error1;
      console.log(error.message);
      return;
    }
    return api.listUnsubscribe({
      id: listId,
      email_address: emailAddress,
      double_optin: false
    }, function(error, data) {
      if (error) {
        return message.send("Uh oh, something went wrong: " + error.message);
      } else {
        return message.send("You successfully unsubscribed " + emailAddress + ".");
      }
    });
  };

  latestCampaign = function(message) {
    var api, error, error1;
    try {
      api = new MailChimpAPI(apiKey, {
        version: "1.3",
        secure: false
      });
    } catch (error1) {
      error = error1;
      console.log(error.message);
      return;
    }
    return api.campaigns({
      start: 0,
      limit: 1
    }, function(error, data) {
      var campaign_name, cid;
      if (error) {
        return message.send("Uh oh, something went wrong: " + error.message);
      } else {
        cid = data['data'][0]['id'];
        campaign_name = data['data'][0]['title'];
        return api.campaignStats({
          cid: cid
        }, function(error, data) {
          if (error) {
            return message.send("Uh oh, something went wrong: " + error.message);
          } else {
            return message.send("Last campaign \"" + campaign_name + "\" was sent to " + data['emails_sent'] + " subscribers (" + data['unique_opens'] + " opened, " + data['unique_clicks'] + " clicked, " + data['unsubscribes'] + " unsubscribed)");
          }
        });
      }
    });
  };

}).call(this);
